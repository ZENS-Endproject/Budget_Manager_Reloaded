name: Build and Deploy (GitHub Container Registry - GHCR)

on:
  #push:
    #branches: [ main ]
  workflow_dispatch:
     
jobs: 
    build:
        runs-on: ubuntu-latest

#permissions:
        #contents: read
        #packages: write   #  Required to push to GHCR
        #
        #id-token: write   # (optional, for OpenIDConnect OIDC deployments with SSO + JWT)

        steps:
      #  Checkout your repository
          - name: Checkout code
            uses: actions/checkout@v4

      #  Cache npm dependencies
          - name: Cache npm modules
            uses: actions/cache@v4
            with:
               path: ~/.npm
               key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
               restore-keys: |
                ${{ runner.os }}-node-

      #  Install dependencies cleanly
          - name: Install dependencies
            run: npm clean install

      #  Build your app (optional)
          - name: Build app
            run: npm run build

      #  Set up Docker Buildx for caching and multi-arch builds
          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v3

      #  Log in to GitHub Container Registry (GHCR)
          - name: Log in to GHCR
            uses: docker/login-action@v3
            with:
              registry: ghcr.io
              username: ${{ github.username }}
              password: ${{ secrets.GITHUB_TOKEN }}

      #  Build & push Docker image with cache
          - name: Build and push Docker image
            uses: docker/build-push-action@v6
            with:
             context: .
             file: ./Dockerfile
             push: true
          #  Your image will be hosted at: ghcr.io/<org-or-user>/<repo>:latest
             tags: ghcr.io/${{ github.repository_owner }}/myapp:latest
             cache-from: type=gha
             cache-to: type=gha,mode=max
