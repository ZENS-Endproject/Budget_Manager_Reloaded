name: Terraform_Apply

on: 
  push:
    tags:
      - 'v*'

  workflow_dispatch:

jobs:
    terraform-apply:
        runs-on: ubuntu-latest
        steps:

#            - name: Post a message in a channel
#              uses: slackapi/slack-github-action@v2.1.1
#              with:
#                webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
#                webhook-type: incoming-webhook
#                payload: |
#                    text: "ðŸš€ Pipeline wurde soeben gestartet. Pipeline: ${{github.workflow}}"

            - name: Checkout
              uses: actions/checkout@v5

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3

            - name: Setup AWS Credentials
              uses: aws-actions/configure-aws-credentials@v5
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_ACCESS_SECRET_KEY }}
                  aws-region: eu-central-1

            - name: Terraform Init
              run: | 
                BRANCH_NAME=${GITHUB_REF##*/}
                # Sanitize the branch name for S3 (replace slashes)
                SAFE_BRANCH=$(echo "$BRANCH_NAME" | tr '/' '-')
                BUCKET_NAME="tf-bud-relo-state-bucket-${SAFE_BRANCH}"
                echo "Using bucket: $BUCKET_NAME"
                cd budget-infra
                terraform init -backend-config="key=infra/${SAFE_BRANCH}/terraform.tfstate"

            - name: Terraform Apply
              run: | 
                cd budget-infra
                terraform apply -var "db_password=${{ secrets.DB_PASSWORD }}" -auto-approve

            - name: ssh setup
            # sleep ist nur provisorisch hier, mÃ¼sste optimiert werden
              run: | 
                sleep 30
                cd budget-infra
                ip=$(terraform output -raw public_ip)
                mkdir -p ~/.ssh
                echo "${{secrets.AWS_EC2_KEY_PEM}}" > ~/.ssh/myPrivateKey
                chmod 400 ~/.ssh/myPrivateKey
                ssh-keyscan -H $ip >> ~/.ssh/known_hosts 

            - name: install docker-compose & npm
              run: |
                cd budget-infra
                ip=$(terraform output -raw public_ip)
                ssh -i ~/.ssh/myPrivateKey ubuntu@$ip "sudo apt update"
                ssh -i ~/.ssh/myPrivateKey ubuntu@$ip "sudo apt install docker.io -y"
                ssh -i ~/.ssh/myPrivateKey ubuntu@$ip "sudo usermod -aG docker ubuntu"   
                ssh -i ~/.ssh/myPrivateKey ubuntu@$ip "sudo apt install docker-compose -y"
           #ssh -i ~/.ssh/myPrivateKey ubuntu@$ip "sudo apt install npm -y"      
            
            - name: scp repo
              run: |
               cd budget-infra
               ip=$(terraform output -raw public_ip)
               scp -i ~/.ssh/myPrivateKey -r /home/runner/work/Budget_Manager_Reloaded/Budget_Manager_Reloaded ubuntu@$ip:/home/ubuntu
               ssh -i ~/.ssh/myPrivateKey ubuntu@$ip "
               echo "DB_HOST=$ip" > "/home/ubuntu/Budget_Manager_Reloaded/backend/.env.local"
               echo "REACT_APP_API_URL=http://$ip:5005"  > "/home/ubuntu/Budget_Manager_Reloaded/frontend/.env.local"
               cd ~/Budget_Manager_Reloaded
               docker-compose up -d   
               "
               
            - name: Initialize DB schema
              run: |
                sudo apt install postgresql-client -y
                psql "host=${{ steps.tf.outputs.rds_endpoint }} port=5432 user=postgres dbname=budget password=${{ secrets.DB_PASSWORD }}" -f ./backend/budget_2025-05-08.sql
               
